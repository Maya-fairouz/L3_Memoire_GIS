{% extends 'base.html' %}

{% load static %}

{% block content %}
<h3 class="page-title">
  <span class="page-title-icon bg-gradient-primary text-white me-2">
    <i class="mdi mdi-image-broken-variant"></i>
  </span> Manage Incidents 
</h3>
<nav aria-label="breadcrumb">
  <ul class="breadcrumb">
    <li class="breadcrumb-item active" aria-current="page">
      <span></span>Overview <i class="mdi mdi-alert-circle-outline icon-sm text-primary align-middle"></i>
    </li>
  </ul>
</nav>
</div>

<form action="{% url 'create-incidents' %}" method="POST" class="forms-sample">
  {% csrf_token %}
  

  <div class="form-group">
    <label for="vehicle">Vehicle</label>
    <select class="form-control" id="vehicle" name="vehicle">
      {% for vehicle in vehicles %}
        <option value="{{ vehicle.id }}">{{ vehicle.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="type">Type</label>
    <select class="form-control" id="type" name="type">
      <option value="Collision">Collision</option>
      <option value="Vandalism">Vandalism</option>
      <option value="Fire">Fire</option>
      <option value="Signal Failure">Signal Failure</option>
      <option value="Track Obstruction">Track Obstruction</option>
      <option value="Equipment Malfunction">Equipment Malfunction</option>
      <option value="Emergency Situation">Emergency Situation</option>

    </select>
  </div>
  <div class="form-group">
    <label>Location</label>
    <input type="text" id="location" class="form-control" name="location" readonly>
    <br>
    <div id="map" style="height: 250px; width: 250px;"></div>
  </div>


  <div class="form-group">
    <label for="exampleTextarea1">Description</label>
    <textarea class="form-control" id="exampleTextarea1" name="description" rows="4"></textarea>
  </div> 

  <div class="form-group">
    <label for="status">Status</label>
    <select class="form-control" id="status" name="status">
      <option value="Pending">Pending</option>
      <option value="Fixed">Fixed</option>
  
    </select>
  </div>
  

  <div class="form-group">
    <label for="reported-by">Reported By</label>
    <input type="text" id="reported-by" class="form-control" name="reported_by" value="{{ user.username }}" readonly>
  </div>


  

  <button type="submit" class="btn btn-gradient-primary me-2">Submit</button>
  <button class="btn btn-light">Cancel</button>
</form>
  <script>

    let map =L.map('map').setView([36.3071,6.5963] , 12);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var marker;
    map.on('click',(event)=>{
      console.log(event)
    })

    map.on('click', function (e) {
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker(e.latlng).addTo(map);
      document.getElementById('location').value = e.latlng.lat + ', ' + e.latlng.lng;
    });
    
    $(document).on('submit', 'form', function(e) {
      e.preventDefault();
    
      // Retrieve the form field values
      var location = document.getElementById('location').value;
      var description = document.getElementById('exampleTextarea1').value;
    
      // Perform any additional processing or validation here
    
      // Submit the form data via AJAX or regular form submission
      $.ajax({
        type: 'POST',
        url: $(this).attr('action'),
        data: {
          location: location,
          description: description,
          csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
          // Handle the success response
        },
        error: function(response) {
          // Handle the error response
        }
      });
    });
  </script>
{% endblock %}
